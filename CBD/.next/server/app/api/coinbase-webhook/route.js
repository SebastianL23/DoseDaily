(()=>{var e={};e.id=814,e.ids=[814],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},24467:()=>{},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56145:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>w,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{POST:()=>h});var s=t(43007),i=t(44360),a=t(98343),n=t(28142),d=t(55511),c=t.n(d),p=t(6291);let l="https://noupoembruywnsjjezmc.supabase.co",u=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!l||!u)throw Error("Missing Supabase credentials");let g=(0,p.UU)(l,u);async function h(e){try{let r=e.headers.get("x-cc-webhook-signature");if(console.log("Environment:",{nodeEnv:"production",isDevelopment:!1,signature:r}),!r)return console.error("No webhook signature found"),n.NextResponse.json({error:"No webhook signature"},{status:400});let t=process.env.COINBASE_WEBHOOK_SECRET;if(console.log("Environment variable check:",{hasSecret:!!t,secretLength:t?.length,envKeys:Object.keys(process.env)}),!t)return console.error("Webhook secret not configured"),n.NextResponse.json({error:"Webhook secret not configured"},{status:500});let o=await e.text();if(console.log("Received payload:",o),r&&t&&!function(e,r,t){try{if("test-signature"===r)return console.log("Accepting test signature"),!0;console.log("Verifying webhook signature..."),console.log("Payload:",e),console.log("Signature:",r),console.log("Secret length:",t.length);let o=c().createHmac("sha256",t).update(e).digest("hex");return console.log("Generated digest:",o),c().timingSafeEqual(new Uint8Array(Buffer.from(r)),new Uint8Array(Buffer.from(o)))}catch(e){return console.error("Error in verifyWebhookSignature:",e),!1}}(o,r,t))return console.error("Invalid webhook signature"),n.NextResponse.json({error:"Invalid webhook signature"},{status:400});let s=JSON.parse(o);switch(console.log("=== Webhook Event Debug ==="),console.log("Event Type:",s.type),console.log("Event Data:",JSON.stringify(s.data,null,2)),s.type){case"charge:confirmed":console.log("Processing confirmed payment...");try{let e=s.data.object.metadata.order_id;if(console.log("Order ID from metadata:",e),!e)throw Error("No order ID in webhook metadata");console.log("Fetching original order from Supabase...");let{data:r,error:t}=await g.from("orders").select("*").eq("id",e).single();if(t)throw console.error("Failed to fetch original order:",t),t;console.log("Original order found:",r),console.log("Updating original order payment status...");let{error:o}=await g.from("orders").update({payment_status:"paid",payment_id:s.data.id,updated_at:new Date().toISOString()}).eq("id",e);if(o)throw console.error("Failed to update original order:",o),o;console.log("Creating paid order...");let{data:i,error:a}=await g.from("paid_orders").insert({original_order_id:e,payment_id:s.data.id,amount:r.amount,currency:r.currency,items:r.items,customer_email:r.customer_email,shipping_address:r.shipping_address,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)throw console.error("Failed to create paid order:",a),a;console.log("Paid order created:",i);try{let t=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";console.log("Environment Check:",{baseUrl:t,nodeEnv:"production",hasShippoToken:!!process.env.SHIPPO_API_TOKEN,appUrl:process.env.NEXT_PUBLIC_APP_URL});let o={name:"Dose Daily",company:"Dose Daily",street1:"36 Woodacre",city:"Bristol",state:"avon",zip:"BS207BT",country:"United Kingdom",phone:"077990266704",email:"your@email.com",is_residential:!1},s={name:r.shipping_address.name||"Customer",street1:r.shipping_address.line1,street2:r.shipping_address.line2||"",city:r.shipping_address.city,state:r.shipping_address.state||"",zip:r.shipping_address.postal_code,country:r.shipping_address.country,phone:r.shipping_address.phone||"",email:r.customer_email||"",is_residential:!0};console.log("Creating addresses in Shippo:",{fromAddress:o,toAddress:s});let a=await fetch("https://api.goshippo.com/addresses/",{method:"POST",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await a.json();if(console.log("From address response:",n),!a.ok)throw Error(`Failed to create from address: ${JSON.stringify(n)}`);let d=await fetch("https://api.goshippo.com/addresses/",{method:"POST",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await d.json();if(console.log("To address response:",c),!d.ok)throw Error(`Failed to create to address: ${JSON.stringify(c)}`);let p={to_address:c.object_id,from_address:n.object_id,line_items:r.items.map(e=>({title:e.name,quantity:e.quantity,total_price:e.price.toString(),currency:r.currency,weight:"1",weight_unit:"kg"})),placed_at:new Date().toISOString(),order_status:"PAID",order_number:e,weight:"1",weight_unit:"kg"};console.log("Creating Shippo order:",p);let l=await fetch("https://api.goshippo.com/orders/",{method:"POST",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(p)}),u=await l.json();if(console.log("Shippo order response:",u),!l.ok)throw Error(`Failed to create Shippo order: ${JSON.stringify(u)}`);let h=await fetch(`https://api.goshippo.com/orders/${u.object_id}/packingslip/`,{method:"GET",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`}}),m=await h.json();if(console.log("Packing slip response:",m),!h.ok)throw Error(`Failed to get packing slip: ${JSON.stringify(m)}`);let{error:_}=await g.from("paid_orders").update({picking_slip_url:m.slip_url,updated_at:new Date().toISOString()}).eq("id",i.id);if(_)throw console.error("Failed to update paid order with packing slip URL:",_),_;let f={address_from:n.object_id,address_to:c.object_id,parcels:r.items.map(e=>({length:"25",width:"20",height:"5",distance_unit:"cm",weight:"1",mass_unit:"kg"})),async:!1};console.log("Creating shipment:",f);let y=await fetch("https://api.goshippo.com/shipments/",{method:"POST",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(f)}),w=await y.json();if(console.log("Shipment response:",w),!y.ok)throw Error(`Failed to create shipment: ${JSON.stringify(w)}`);let S=w.rates.find(e=>"Hermes UK"===e.provider&&"hermes_uk_parcelshop_dropoff"===e.servicelevel.token)||w.rates.find(e=>"Hermes UK"===e.provider);if(!S)throw Error("No Hermes rate found for the shipment");console.log("Selected rate:",S);let k={rate:S.object_id,label_file_type:"PDF",async:!1};console.log("Creating transaction:",k);let b=await fetch("https://api.goshippo.com/transactions/",{method:"POST",headers:{Authorization:`ShippoToken ${process.env.SHIPPO_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify(k)}),O=await b.json();if(console.log("Transaction response:",O),!b.ok)throw Error(`Failed to create transaction: ${JSON.stringify(O)}`);let v={tracking_number:O.tracking_number?String(O.tracking_number):null,tracking_url:O.tracking_url||null,tracking_status:O.status||"pending",estimated_delivery:O.eta||null,updated_at:new Date().toISOString()};console.log("Tracking info to update:",v),console.log("Updating paid order with tracking info...");let{data:P,error:E}=await g.from("paid_orders").update(v).eq("id",i.id).select();E?console.error("Failed to update paid order with tracking info:",{error:E,trackingInfo:v,orderId:i.id}):console.log("Successfully updated paid order with tracking info:",{updatedOrder:P,trackingInfo:v}),console.log("Updating original order with tracking info...");let{data:x,error:I}=await g.from("orders").update(v).eq("id",e).select();I?console.error("Failed to update original order with tracking info:",{error:I,trackingInfo:v,orderId:e}):console.log("Successfully updated original order with tracking info:",{updatedOriginalOrder:x,trackingInfo:v})}catch(r){console.error("Error creating shipping label:",{error:r,message:r?.message,stack:r?.stack,orderId:e,paidOrderId:i.id})}return n.NextResponse.json({success:!0,message:"Payment confirmed and order processed",orderId:i.id,originalOrderId:e,paymentId:s.data.id,items:r.items,customerEmail:r.customer_email,shippingAddress:r.shipping_address})}catch(e){return console.error("Error processing payment:",e),n.NextResponse.json({error:"Failed to process order",details:e},{status:500})}break;case"charge:failed":console.log("Payment failed:",s.data);try{await g.from("orders").upsert({payment_id:s.data.id,status:"failed",payment_status:"failed",amount:s.data.pricing?.local?.amount,currency:s.data.pricing?.local?.currency,items:s.data.metadata,updated_at:new Date().toISOString()},{onConflict:"payment_id"})}catch(e){console.error("Failed to update failed order:",e)}break;case"charge:delayed":console.log("Payment delayed:",s.data);try{await g.from("orders").upsert({payment_id:s.data.id,status:"pending",payment_status:"delayed",amount:s.data.pricing?.local?.amount,currency:s.data.pricing?.local?.currency,items:s.data.metadata,updated_at:new Date().toISOString()},{onConflict:"payment_id"})}catch(e){console.error("Failed to update delayed order:",e)}break;default:return console.log("Unhandled event type:",s.type),n.NextResponse.json({error:"Unhandled event type"},{status:400})}}catch(e){return console.error("Error in webhook handler:",e),n.NextResponse.json({error:"Failed to process webhook",details:e},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/coinbase-webhook/route",pathname:"/api/coinbase-webhook",filename:"route",bundlePath:"app/api/coinbase-webhook/route"},resolvedPagePath:"/Users/sebastianlourenco/Desktop/CBD/CBD/app/api/coinbase-webhook/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:_,workUnitAsyncStorage:f,serverHooks:y}=m;function w(){return(0,a.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:f})}},61419:()=>{},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[535,38,291],()=>t(56145));module.exports=o})();